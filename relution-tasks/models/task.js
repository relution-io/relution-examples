"use strict";
var _ = require('lodash');
var Q = require('q');
var backbone = require('backbone');
var datasync = require('relution/datasync.js');
var security = require('relution/security.js');
var push = require('relution/push.js');
exports.options = {
    entity: 'Task',
    type: {
        container: 'relution-tasks MetaModelContainer',
        model: 'Task'
    },
    idAttribute: 'id',
    aclAttribute: 'aclEntries',
    backbone: backbone,
    sync: datasync.sync,
    backend: new datasync.Backend({
        create: createTask,
        update: updateTask,
        delete: deleteTask
    })
};
function setupTask(task) {
    var me = security.getCurrentUser('name');
    task.creator = task.creator || me.name;
    task.assignee = task.assignee || me.name;
    var now = new Date();
    task.createdAt = task.createdAt || now;
    task.modifiedAt = task.modifiedAt || task.createdAt;
    task.dueTo = task.dueTo || new Date(task.createdAt.getTime() + 24 * 60 * 60 * 1000);
    var acl = [
        me.name,
        task.creator,
        task.assignee
    ];
    acl = _.compact(acl);
    acl = _.uniq(acl);
    acl = _.map(acl, function (name) {
        var user = security.getUserByName(name, 'uuid');
        return user.uuid + ':rw';
    });
    task.aclEntries = acl;
}
function createTask(task, model, options) {
    task.id = task.id || ('task-' + Date.now());
    setupTask(task);
    if (task.state === 'open' && task.assignee !== task.creator) {
        var assignee = security.getUserByName(task.assignee, 'uuid');
        push.postPushNotification({
            description: 'A new task is assigned to you: ' + task.title,
            badge: '+1',
            extras: {
                i18n: 'TASK_NEW',
                id: task.id
            },
            deviceFilter: push.pushDeviceFilterByUsers(assignee)
        });
    }
    return Q(task);
}
exports.createTask = createTask;
function updateTask(task, model, options) {
    setupTask(task);
    return Q(task);
}
exports.updateTask = updateTask;
function deleteTask(task, model, options) {
    return Q(task);
}
exports.deleteTask = deleteTask;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGFzay5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInRhc2sudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLElBQVksQ0FBQyxXQUFNLFFBQVEsQ0FBQyxDQUFBO0FBQzVCLElBQVksQ0FBQyxXQUFNLEdBQUcsQ0FBQyxDQUFBO0FBRXZCLElBQU0sUUFBUSxHQUFHLE9BQU8sQ0FBQyxVQUFVLENBQUMsQ0FBQztBQUNyQyxJQUFNLFFBQVEsR0FBRyxPQUFPLENBQUMsc0JBQXNCLENBQUMsQ0FBQztBQUNqRCxJQUFNLFFBQVEsR0FBRyxPQUFPLENBQUMsc0JBQXNCLENBQUMsQ0FBQztBQUNqRCxJQUFNLElBQUksR0FBRyxPQUFPLENBQUMsa0JBQWtCLENBQUMsQ0FBQztBQUU1QixlQUFPLEdBQUc7SUFDckIsTUFBTSxFQUFFLE1BQU07SUFDZCxJQUFJLEVBQUU7UUFDSixTQUFTLEVBQUUsbUNBQW1DO1FBQzlDLEtBQUssRUFBRSxNQUFNO0tBQ2Q7SUFFRCxXQUFXLEVBQUUsSUFBSTtJQUNqQixZQUFZLEVBQUUsWUFBWTtJQUUxQixRQUFRLEVBQUUsUUFBUTtJQUNsQixJQUFJLEVBQUUsUUFBUSxDQUFDLElBQUk7SUFFbkIsT0FBTyxFQUFFLElBQUksUUFBUSxDQUFDLE9BQU8sQ0FBQztRQUM1QixNQUFNLEVBQUUsVUFBVTtRQUNsQixNQUFNLEVBQUUsVUFBVTtRQUNsQixNQUFNLEVBQUUsVUFBVTtLQUNuQixDQUFDO0NBQ0gsQ0FBQztBQW1CRixtQkFBbUIsSUFBVTtJQUMzQixJQUFNLEVBQUUsR0FBRyxRQUFRLENBQUMsY0FBYyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQzNDLElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDLE9BQU8sSUFBSSxFQUFFLENBQUMsSUFBSSxDQUFDO0lBQ3ZDLElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDLFFBQVEsSUFBSSxFQUFFLENBQUMsSUFBSSxDQUFDO0lBRXpDLElBQU0sR0FBRyxHQUFHLElBQUksSUFBSSxFQUFFLENBQUM7SUFDdkIsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsU0FBUyxJQUFJLEdBQUcsQ0FBQztJQUN2QyxJQUFJLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQyxVQUFVLElBQUksSUFBSSxDQUFDLFNBQVMsQ0FBQztJQUNwRCxJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQyxLQUFLLElBQUksSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxJQUFJLENBQUMsQ0FBQztJQUVwRixJQUFJLEdBQUcsR0FBRztRQUNSLEVBQUUsQ0FBQyxJQUFJO1FBQ1AsSUFBSSxDQUFDLE9BQU87UUFDWixJQUFJLENBQUMsUUFBUTtLQUNkLENBQUM7SUFDRixHQUFHLEdBQUcsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUNyQixHQUFHLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUNsQixHQUFHLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUUsVUFBQyxJQUFJO1FBQ3BCLElBQU0sSUFBSSxHQUFHLFFBQVEsQ0FBQyxhQUFhLENBQUMsSUFBSSxFQUFFLE1BQU0sQ0FBQyxDQUFDO1FBQ2xELE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxHQUFHLEtBQUssQ0FBQztJQUMzQixDQUFDLENBQUMsQ0FBQztJQUNILElBQUksQ0FBQyxVQUFVLEdBQUcsR0FBRyxDQUFDO0FBQ3hCLENBQUM7QUFFRCxvQkFBMkIsSUFBVSxFQUFFLEtBQUssRUFBRSxPQUFPO0lBQ25ELElBQUksQ0FBQyxFQUFFLEdBQUcsSUFBSSxDQUFDLEVBQUUsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQztJQUM1QyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUM7SUFFaEIsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssS0FBSyxNQUFNLElBQUksSUFBSSxDQUFDLFFBQVEsS0FBSyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztRQUM1RCxJQUFNLFFBQVEsR0FBRyxRQUFRLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsTUFBTSxDQUFDLENBQUM7UUFDL0QsSUFBSSxDQUFDLG9CQUFvQixDQUFDO1lBQ3hCLFdBQVcsRUFBRSxpQ0FBaUMsR0FBRyxJQUFJLENBQUMsS0FBSztZQUMzRCxLQUFLLEVBQUUsSUFBSTtZQUNYLE1BQU0sRUFBRTtnQkFDTixJQUFJLEVBQUUsVUFBVTtnQkFDaEIsRUFBRSxFQUFFLElBQUksQ0FBQyxFQUFFO2FBQ1o7WUFDRCxZQUFZLEVBQUUsSUFBSSxDQUFDLHVCQUF1QixDQUFDLFFBQVEsQ0FBQztTQUNyRCxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRUQsTUFBTSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQztBQUNqQixDQUFDO0FBbEJlLGtCQUFVLGFBa0J6QixDQUFBO0FBRUQsb0JBQTJCLElBQVUsRUFBRSxLQUFLLEVBQUUsT0FBTztJQUNuRCxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDaEIsTUFBTSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQztBQUNqQixDQUFDO0FBSGUsa0JBQVUsYUFHekIsQ0FBQTtBQUVELG9CQUEyQixJQUFVLEVBQUUsS0FBSyxFQUFFLE9BQU87SUFDbkQsTUFBTSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQztBQUNqQixDQUFDO0FBRmUsa0JBQVUsYUFFekIsQ0FBQSJ9